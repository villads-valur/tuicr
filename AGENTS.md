# AGENTS.md - tuicr

This document serves two purposes:
1. Help coding agents understand the tuicr codebase structure
2. Explain how to interpret review feedback generated by tuicr

---

## Project Structure

tuicr is a Rust terminal UI application for code reviews. Here's the module structure:

```
src/
├── main.rs              # Entry point, event loop, action dispatch
├── app.rs               # Application state (App struct, InputMode, etc.)
├── error.rs             # Error types (TuicrError enum)
│
├── git/
│   ├── mod.rs
│   ├── repository.rs    # RepoInfo: git repo discovery, HEAD commit, branch
│   └── diff.rs          # get_working_tree_diff(): parse git diff into DiffFile structs
│
├── model/
│   ├── mod.rs
│   ├── comment.rs       # Comment, CommentType (Note/Suggestion/Issue/Praise)
│   ├── diff_types.rs    # DiffFile, DiffHunk, DiffLine, FileStatus, LineOrigin
│   └── review.rs        # ReviewSession, FileReview (the persisted review state)
│
├── input/
│   ├── mod.rs
│   ├── keybindings.rs   # Action enum, map_key_to_action() for each InputMode
│   └── mode.rs          # InputMode enum definition (unused, defined in app.rs)
│
├── persistence/
│   ├── mod.rs
│   └── storage.rs       # save_session, load_session, find_session_for_repo
│
├── output/
│   ├── mod.rs
│   └── markdown.rs      # export_to_clipboard(): generate markdown, copy to clipboard
│
└── ui/
    ├── mod.rs
    ├── app_layout.rs    # Main render function, file list, diff view with inline comments
    ├── status_bar.rs    # Header, status bar, command line rendering
    ├── help_popup.rs    # Help overlay (? key)
    ├── comment_panel.rs # Comment input dialog, confirm dialog
    └── styles.rs        # Color constants and style helper functions
```

### Key Types

**App** (`src/app.rs`):
- Central application state
- Contains: `repo_info`, `session`, `diff_files`, `input_mode`, scroll/cursor state
- Methods: `scroll_down/up`, `next/prev_file`, `next/prev_hunk`, `toggle_reviewed`, `save_comment`

**InputMode** (`src/app.rs`):
- `Normal` - default navigation mode
- `Command` - after pressing `:`, vim-style commands
- `Comment` - typing a comment (Ctrl-S saves, Ctrl-C cancels)
- `Help` - showing help popup
- `Confirm` - Y/N confirmation dialog

**ReviewSession** (`src/model/review.rs`):
- Persisted review state with `files: HashMap<PathBuf, FileReview>`
- Each `FileReview` has: `reviewed: bool`, `file_comments: Vec<Comment>`, `line_comments: HashMap<u32, Vec<Comment>>`

**Action** (`src/input/keybindings.rs`):
- All possible user actions (ScrollDown, NextFile, ToggleReviewed, AddLineComment, etc.)
- `map_key_to_action(key, mode)` returns the appropriate Action

### Data Flow

1. **Startup**: `App::new()` discovers repo, parses diff, loads existing session if any
2. **Render**: `ui::render()` draws the TUI based on `App` state
3. **Input**: `crossterm` events → `map_key_to_action` → match on Action in main loop
4. **Persistence**: `:w` calls `save_session()`, writes JSON to `~/.local/share/tuicr/reviews/`
5. **Export**: `:e` calls `export_to_clipboard()`, generates markdown, copies to system clipboard

### Important Implementation Details

- **Infinite scroll**: All files rendered into one `Vec<Line>`, then sliced by `scroll_offset`
- **Inline comments**: Comments are rendered in `app_layout.rs` after file headers and after relevant diff lines
- **Session loading**: `App::new()` calls `find_session_for_repo()` to restore previous review
- **Clipboard**: Uses `arboard` crate for cross-platform clipboard support
- **Hunk navigation**: `next_hunk()`/`prev_hunk()` calculate positions by iterating through files

### Dependencies

- `ratatui` + `crossterm`: TUI framework
- `git2`: Native git operations
- `serde` + `serde_json`: Session serialization
- `arboard`: Clipboard access
- `chrono`: Timestamps
- `thiserror` + `anyhow`: Error handling

---

## Review Format (for coding agents receiving tuicr output)

When a user reviews your changes with tuicr, they will provide you with a structured Markdown document.

### Document Structure

```markdown
# Code Review: {project_name}

**Reviewed:** {timestamp}
**Base Commit:** `{commit_sha}`
**Files Reviewed:** {reviewed_count}/{total_count}

## Summary
{optional overall notes}

## Files
{per-file feedback}

## Action Items
{prioritized list of issues to address}
```

### Comment Types

| Type | Meaning | Action Required |
|------|---------|-----------------|
| **[ISSUE]** | Problem that must be fixed | Yes - address before proceeding |
| **[SUGGESTION]** | Improvement recommendation | Consider implementing |
| **[NOTE]** | Observation or question | Respond or acknowledge |
| **[PRAISE]** | Positive feedback | No action needed |

### File Status Markers

- `M` - Modified
- `A` - Added (new file)
- `D` - Deleted
- `R` - Renamed

### How to Respond

#### 1. Address Action Items First

The "Action Items" section contains all **[ISSUE]** comments. These are blocking:

```markdown
## Action Items

1. **`src/auth.rs`:42** - Magic number should be a named constant
2. **`src/api.rs`:15** - Missing error handling for network failure
```

#### 2. Consider Suggestions

**[SUGGESTION]** comments are non-blocking but should be considered. Either implement or explain why not.

#### 3. Answer Questions

**[NOTE]** comments often contain questions. Provide brief explanations.

### Response Format

```markdown
## Changes Made

### Issues Addressed
- `src/auth.rs:42` - Extracted magic number to `TOKEN_EXPIRY_SECONDS` constant

### Suggestions Implemented
- `src/utils.rs` - Replaced Vec with HashMap as suggested

### Suggestions Declined
- `src/config.rs` - Kept current approach because [reason]

### Questions Answered
- The `unsafe` block in `src/ffi.rs` is required for FFI calls
```

## Tips for Coding Agents

1. **Read the full review** before making changes
2. **Prioritize [ISSUE] items** - these are blocking
3. **Preserve reviewer intent** - don't over-engineer solutions
4. **Be concise** in your response
5. **If unclear**, ask for clarification rather than guessing
